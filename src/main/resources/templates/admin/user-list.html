<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Quản lý người dùng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<section layout:fragment="content">
    <h1>Quản lý người dùng</h1>

    <table class="table table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th>Tên đăng nhập</th>
            <th>Email</th>
            <th>Đã phê duyệt</th>
            <th>Đã khóa</th>
            <th>Vai trò</th>
            <th sec:authorize="hasAuthority('ADMIN')">Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users}">
            <td th:text="${user.username}"></td>
            <td th:text="${user.email}"></td>
            <td th:text="${user.approved ? 'Có' : 'Không'}"></td>
            <td th:text="${user.accountNonLocked ? 'Không' : 'Có'}"></td>
            <td>
                <span th:each="role : ${user.roles}" th:text="${role.name}" th:remove="tag">Role</span>
            </td>
            <td sec:authorize="hasAuthority('ADMIN')">
                <div>
                    <button th:data-url="@{/admin/edit/{username}(username=${user.username})}"
                            class="btn btn-success btn-sm edit-user-btn">Chỉnh sửa</button>
                    <button th:data-url="@{/admin/delete/{id}(id=${user.id})}"
                            class="btn btn-danger btn-sm delete-user-btn"
                            onclick="return confirm('Bạn có chắc chắn?')">Xóa</button>
                    <button th:data-url="@{/admin/toggleApproval/{id}(id=${user.id})}"
                            class="btn btn-warning btn-sm toggle-approval-btn"
                            th:text="${user.approved ? 'Hủy phê duyệt' : 'Phê duyệt'}"></button>
                    <button th:data-url="@{/admin/toggleLock/{id}(id=${user.id})}"
                            class="btn btn-secondary btn-sm toggle-lock-btn"
                            th:text="${user.accountNonLocked ? 'Khóa' : 'Mở khóa'}"></button>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const editUserBtns = document.querySelectorAll('.edit-user-btn');
        editUserBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                window.location.href = btn.dataset.url;
            });
        });

        const deleteUserBtns = document.querySelectorAll('.delete-user-btn');
        deleteUserBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm('Bạn có chắc chắn?')) {
                    window.location.href = btn.dataset.url;
                }
            });
        });

        const toggleApprovalBtns = document.querySelectorAll('.toggle-approval-btn');
        toggleApprovalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                fetch(btn.dataset.url, { method: 'GET' })
                    .then(response => {
                        if (response.ok) {
                            location.reload(); // Tải lại trang để cập nhật thay đổi
                        } else {
                            console.error('Lỗi khi chuyển đổi phê duyệt.');
                        }
                    });
            });
        });

        const toggleLockBtns = document.querySelectorAll('.toggle-lock-btn');
        toggleLockBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                fetch(btn.dataset.url, { method: 'GET' })
                    .then(response => {
                        if (response.ok) {
                            location.reload(); // Tải lại trang để cập nhật thay đổi
                        } else {
                            console.error('Lỗi khi chuyển đổi trạng thái khóa.');
                        }
                    });
            });
        });
        /*]]>*/
    </script>
</section>
</body>
</html>
